# GNU GCC — Fase Final
# ------------------------------------------------------------
# Compilador definitivo do LFS com suporte a C e C++, executado dentro
# do chroot, já com glibc e binutils finais instalados.
# ------------------------------------------------------------

[package]
name = "gcc"
version = "13.2.0"
category = "base"
variant = "final"
description = "GNU Compiler Collection (GCC) — Fase final com suporte completo a C e C++."
maintainer = "Zeropkg Build System"
license = "GPL-3.0"
homepage = "https://gcc.gnu.org/"

# ------------------------------------------------------------
# Fontes e libs internas
# ------------------------------------------------------------
[sources]

[[sources.entries]]
url = "https://ftp.gnu.org/gnu/gcc/gcc-13.2.0/gcc-13.2.0.tar.xz"
checksum = "sha256:e73e0b5a7f44f504b2a72edb41b8f03c5e78e3cf07b5b905c8f26e24e70da427"
format = "tar.xz"
priority = 1

[[sources.entries]]
url = "https://ftp.gnu.org/gnu/mpfr/mpfr-4.2.1.tar.xz"
extract_to = "gcc-13.2.0/mpfr"
priority = 2

[[sources.entries]]
url = "https://ftp.gnu.org/gnu/gmp/gmp-6.3.0.tar.xz"
extract_to = "gcc-13.2.0/gmp"
priority = 3

[[sources.entries]]
url = "https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz"
extract_to = "gcc-13.2.0/mpc"
priority = 4

# ------------------------------------------------------------
# Ambiente
# ------------------------------------------------------------
[environment]
PATH = "/usr/bin"
CFLAGS = "-O2 -pipe -fPIC"
CXXFLAGS = "-O2 -pipe -fPIC"
LDFLAGS = "-Wl,-O1"
MAKEFLAGS = "-j$(nproc)"
LANG = "C.UTF-8"
LC_ALL = "C.UTF-8"

# ------------------------------------------------------------
# Dependências — renomeadas conforme receitas Zeropkg
# ------------------------------------------------------------
[dependencies]
build = ["binutils-2.43.1", "glibc-2.39", "zlib-1.3.1", "make", "texinfo"]
runtime = ["glibc-2.39", "zlib-1.3.1", "mpfr-4.2.1", "gmp-6.3.0", "mpc-1.3.1"]
optional = ["isl-0.26"]

# ------------------------------------------------------------
# Patches (opcionais)
# ------------------------------------------------------------
[patches]
files = []

# ------------------------------------------------------------
# Hooks
# ------------------------------------------------------------
[hooks]
pre_configure = ""
post_configure = ""
pre_build = ""
post_build = ""
pre_install = ""
post_install = "scripts/update-info-dir.sh"
pre_remove = ""
post_remove = ""

# ------------------------------------------------------------
# Construção real
# ------------------------------------------------------------
[build]
system = "custom"
fakeroot = true
chroot = true
strip_binaries = true
commands = [
    "mkdir -pv build",
    "cd build",
    "../configure                                       \\
        --prefix=/usr                                   \\
        --enable-languages=c,c++                        \\
        --disable-multilib                              \\
        --disable-bootstrap                             \\
        --with-system-zlib                              \\
        --enable-shared                                 \\
        --enable-threads=posix                          \\
        --enable-lto                                    \\
        --enable-default-pie                            \\
        --enable-default-ssp                            \\
        --enable-host-shared                            \\
        --enable-linker-build-id                        \\
        --enable-plugin                                 \\
        --enable-gold                                   \\
        --with-system-libunwind                         \\
        --enable-checking=release",
    "make",
    "make -k check || true",
    "make install",
    "rm -f /usr/lib/lib{gcc_s,atomic,gomp,quadmath,ssp,vtv}.la",
    "ln -sfv ../usr/bin/cpp /lib",
    "ln -sfv gcc /usr/bin/cc"
]

# ------------------------------------------------------------
# Pós-instalação
# ------------------------------------------------------------
[post_install]
register = true
update_cache = true
clean_build_dir = true
notify = true

# ------------------------------------------------------------
# LFS
# ------------------------------------------------------------
[lfs]
stage = "final"
toolchain = false
bootstrap = false
chroot_required = true

# ------------------------------------------------------------
# Segurança
# ------------------------------------------------------------
[security]
verify_checksums = true
use_chroot = true
fakeroot = true
signature_check = false

# ------------------------------------------------------------
# Empacotamento
# ------------------------------------------------------------
[package_build]
enabled = true
type = "tar"
output_dir = "/var/zeropkg/packages"
compress = "xz"
include_docs = true
